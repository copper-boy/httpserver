<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <style>
        table, th, td {
            border: 1px solid;
        }
    </style>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

    <script type="text/javascript" src="https://unpkg.com/xlsx@0.15.1/dist/xlsx.full.min.js"></script>
    
    <script>
        function get_files_names() {
            var xmlhttp = new XMLHttpRequest();

            // Define a callback function
            xmlhttp.onload = function () {
                if (xmlhttp.status == 200) {
                    var files = document.querySelector('#files_list');
                    files.innerHTML = "<option>Select file</option>";
                    let array = xmlhttp.responseText.split(';');
                    if (!array.length) {
                        return;
                    }
                    array.forEach(function(item, index, response) {
                        files.add(new Option(item));
                    });
                }


            }

            // Send a request
            xmlhttp.open("GET", "http://localhost:8000/db/?file=true", true);
            xmlhttp.send();
        }

        function get_table_names() {
            var files = document.querySelector('#files_list');

            if (files.value != "Select file") {
                var xmlhttp = new XMLHttpRequest();
                // Define a callback function
                xmlhttp.onload = function () {
                    if (xmlhttp.status == 200) {
                        var tables = document.querySelector('#tables_list');
                        tables.innerHTML = "<option>Select table</option>"
                        let array = xmlhttp.responseText.split(';');
                        if (!array.length) {
                            return;
                        }
                        array.forEach(function(item, index, response) {
                            tables.add(new Option(item));
                        });
                    }
                }
                // Send a request
                xmlhttp.open("GET", `http://localhost:8000/db/?file=${files.value}&table=true`, true);
                xmlhttp.send();
            }
        }

        function download_excel() {
            var files = document.querySelector('#files_list');
            var tables = document.querySelector('#tables_list');
            
            var ref = document.getElementById("reference");
            if (files.value != "Select file" && tables.value != "Select table") {
                ref.setAttribute("href", `http://localhost:8000/db/${files.value}/${tables.value}`);
            } else {
                ref.setAttribute("href", "");
            }
        }

        function send_database_file() {
            let db = document.getElementById("database").files[0];
            let req = new XMLHttpRequest();
            let formData = new FormData();
            formData.append("database", db);                     
            req.open("POST", 'http://localhost:8000/db/post/');
            req.send(formData);
        }

        function delete_database_file() {
            var files = document.querySelector('#files_list');
            if (files.value != "Select file") {
                var xmlhttp = new XMLHttpRequest();
                xmlhttp.onload = function () {
                    if (xmlhttp.status == 200) {
                        get_files_names();
                        get_table_names();
                    }
                }

            // Send a request
            xmlhttp.open("DELETE", `http://localhost:8000/db/delete/${files.value}`, true);
            xmlhttp.send();
            }
        }

        function show_table() {
            var files = document.querySelector('#files_list');
            var tables = document.querySelector('#tables_list');
            
            var ref = document.getElementById("reference");
            if (files.value != "Select file" && tables.value != "Select table") {
                var xhr = new XMLHttpRequest();
                xhr.open('get', `http://localhost:8000/db/${files.value}/${tables.value}`, true);
                xhr.responseType = 'arraybuffer';
                xhr.onload = function() {
                    if (xhr.status != 200) {
                        return;
                    }
                    var data = new Uint8Array(xhr.response);
                    var work_book = XLSX.read(data, {type:'array'});
                    var sheet_name = work_book.SheetNames;
                    var sheet_data = XLSX.utils.sheet_to_json(work_book.Sheets[sheet_name[0]], {header:1});
                    
                    if (sheet_data.length > 0) {
                        var table_output = '<table class="table table-striped table-bordered">';
                        
                        for(var row = 0; row < sheet_data.length; row++) {
                            table_output += '<tr>';
                            
                            for(var cell = 0; cell < sheet_data[row].length; cell++) {
                                if(row == 0) {
                                    table_output += '<th>'+sheet_data[row][cell]+'</th>';
                                }
                                else {
                                    table_output += '<td>'+sheet_data[row][cell]+'</td>';
                                }
                            }
                            table_output += '</tr>';
                        }
                        table_output += '</table>';
                        document.getElementById('excel_data').innerHTML = table_output;
                    }
                }
                xhr.send();
            }
        }
    </script>
</head>

<body>
    <select id="files_list">
        <option>Select file</option>
    </select>

    <select id="tables_list">
        <option>Select table</option>
    </select>

    <button type="button" onclick="get_files_names()">Update files list</button>
    <button type="button" onclick="get_table_names()">Update tables list</button>
    <button type="button" onclick="send_database_file()">Send database file</button>
    <input type="file" name="file" id="database">
    <button type="button" onclick="delete_database_file()">Delete database file</button>
    <button type="button" onclick="download_excel()">Set download reference</button>
    <a id="reference" href="">Download reference</a>
    <button type="button" onclick="show_table()">Show table</button>
    <div id="excel_data" class="mt-5"></div>
</body>

</html>